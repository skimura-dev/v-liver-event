<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¯¾æŠ—æˆ¦ çµ±åˆç®¡ç†ãƒ‘ãƒãƒ«</title>
    <style>
        body { font-family: sans-serif; background: #f4f4f4; padding: 20px; padding-bottom: 100px; }
        
        /* ä¿å­˜ã‚¨ãƒªã‚¢ï¼ˆç”»é¢ä¸Šéƒ¨ã«å›ºå®šï¼‰ */
        .sticky-header {
            position: sticky; top: 0; z-index: 100;
            background: rgba(255,255,255,0.95);
            border-bottom: 2px solid #ccc;
            padding: 15px; text-align: center;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            margin: -20px -20px 20px -20px;
        }
        .save-btn { padding: 12px 50px; background: #333; color: white; border: none; font-size: 18px; font-weight: bold; border-radius: 5px; cursor: pointer; }
        .save-btn:hover { background: #555; }
        
        /* å®¹é‡ãƒ¡ãƒ¼ã‚¿ãƒ¼ */
        .storage-meter { width: 300px; height: 10px; background: #ddd; margin: 10px auto 0; border-radius: 5px; overflow: hidden; }
        .storage-fill { height: 100%; background: #4caf50; width: 0%; transition: width 0.5s; }
        .storage-text { font-size: 11px; color: #666; margin-top: 2px; }

        .container { display: flex; gap: 20px; max-width: 1400px; margin: 0 auto; overflow-x: auto; padding-top: 20px; }
        
        .editor-card {
            flex: 1; min-width: 350px;
            background: white; padding: 20px; border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            border-top: 6px solid #ccc;
        }
        .red { border-color: #ff4d4d; }
        .blue { border-color: #4d79ff; }
        .yellow { border-color: #ffcc00; }

        h2 { text-align: center; margin: 0 0 20px; text-transform: uppercase; letter-spacing: 1px; }
        h3 { background: #eee; padding: 8px; border-radius: 4px; font-size: 14px; margin-top: 20px; margin-bottom: 10px; }

        label { display: block; font-weight: bold; font-size: 12px; margin-bottom: 3px; color: #555; }
        input[type="text"], input[type="file"] { width: 100%; padding: 6px; box-sizing: border-box; margin-bottom: 8px; font-size: 13px; }
        
        .preview-img { display: block; width: 60px; height: 60px; object-fit: cover; border-radius: 50%; margin: 5px auto; background: #ddd; border: 2px solid white; box-shadow: 0 0 3px rgba(0,0,0,0.2); }

        .member-list {
            background: #fafafa; border: 1px solid #eee; 
            height: 200px; overflow-y: auto; padding: 5px; margin-bottom: 10px;
        }
        .member-item {
            display: flex; align-items: center; background: white; 
            padding: 5px; margin-bottom: 5px; border-radius: 4px; border: 1px solid #eee;
        }
        .member-thumb { width: 30px; height: 30px; border-radius: 50%; object-fit: cover; margin-right: 10px; background: #ccc; }
        .member-info { flex: 1; overflow: hidden; }
        .member-name { font-size: 12px; font-weight: bold; }
        .del-btn { background: #ff4d4d; color: white; border: none; padding: 4px 8px; font-size: 10px; cursor: pointer; border-radius: 3px; margin-left: 5px;}

        .add-area { background: #eef; padding: 10px; border-radius: 5px; border: 1px dashed #ccc; }
        .add-btn { width: 100%; background: #4d79ff; color: white; padding: 8px; border: none; border-radius: 4px; cursor: pointer; margin-top: 5px; }

        #msg { color: green; font-weight: bold; height: 20px; margin-top: 5px; }
        .alert { color: red; font-weight: bold; }
    </style>
</head>
<body>

    <div class="sticky-header">
        <button class="save-btn" onclick="saveAllData()">å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜</button>
        <div id="msg"></div>
        
        <div class="storage-meter"><div id="storageFill" class="storage-fill"></div></div>
        <div class="storage-text" id="storageText">å®¹é‡ä½¿ç”¨ç‡: è¨ˆç®—ä¸­...</div>

        <div style="font-size:12px; margin-top:5px;">
            <a href="index.html" target="_blank">ãƒ›ãƒ¼ãƒ (å›£é•·)</a> | 
            <a href="red.html" target="_blank">èµ¤çµ„</a> | 
            <a href="blue.html" target="_blank">é’çµ„</a> | 
            <a href="yellow.html" target="_blank">é»„çµ„</a>
        </div>
    </div>

    <div class="container" id="app-container">
        </div>

<script>
    const TEAMS = [
        { id: 'red', name: 'RED TEAM', colorClass: 'red' },
        { id: 'blue', name: 'BLUE TEAM', colorClass: 'blue' },
        { id: 'yellow', name: 'YELLOW TEAM', colorClass: 'yellow' }
    ];

    const dataStore = {
        red: { leaders: [{}, {}], members: [] },
        blue: { leaders: [{}, {}], members: [] },
        yellow: { leaders: [{}, {}], members: [] }
    };

    window.onload = function() {
        const container = document.getElementById('app-container');
        
        // ãƒ•ã‚©ãƒ¼ãƒ ç”Ÿæˆ
        TEAMS.forEach(team => {
            const html = `
                <div class="editor-card ${team.colorClass}">
                    <h2>${team.name}</h2>
                    
                    <h3>ğŸ‘‘ å›£é•·è¨­å®š (æœ€å¤§2å)</h3>
                    ${createLeaderForm(team.id, 1)}
                    ${createLeaderForm(team.id, 2)}

                    <h3>ğŸ‘¥ ãƒ¡ãƒ³ãƒãƒ¼ãƒªã‚¹ãƒˆ</h3>
                    <div class="member-list" id="list-${team.id}"></div>
                    
                    <div class="add-area">
                        <label>æ–°è¦ãƒ¡ãƒ³ãƒãƒ¼ç”»åƒ</label>
                        <input type="file" id="new-file-${team.id}" accept="image/*">
                        <label>åå‰</label>
                        <input type="text" id="new-name-${team.id}" placeholder="åå‰">
                        <label>ãƒªãƒ³ã‚¯</label>
                        <input type="text" id="new-link-${team.id}" placeholder="https://...">
                        <button class="add-btn" onclick="addMember('${team.id}')">ï¼‹ ãƒªã‚¹ãƒˆã«è¿½åŠ </button>
                    </div>
                </div>
            `;
            container.innerHTML += html;
        });

        // ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿
        TEAMS.forEach(team => loadTeamData(team.id));
        
        // å®¹é‡ãƒã‚§ãƒƒã‚¯
        checkStorageUsage();
    };

    function createLeaderForm(teamId, num) {
        return `
            <div style="border-bottom:1px dashed #ddd; margin-bottom:10px; padding-bottom:5px;">
                <label>å›£é•·${num}</label>
                <img id="preview-${teamId}-${num}" class="preview-img" src="">
                <input type="file" onchange="previewLeader(this, '${teamId}', ${num})" accept="image/*">
                <input type="text" id="name-${teamId}-${num}" placeholder="å›£é•·${num}ã®åå‰">
                <input type="text" id="link-${teamId}-${num}" placeholder="å›£é•·${num}ã®ãƒªãƒ³ã‚¯">
            </div>
        `;
    }

    function loadTeamData(color) {
        const savedLeaders = JSON.parse(localStorage.getItem('team_' + color + '_leaders'));
        if (savedLeaders && Array.isArray(savedLeaders)) {
            dataStore[color].leaders = savedLeaders;
            for (let i = 1; i <= 2; i++) {
                const data = savedLeaders[i-1] || {};
                document.getElementById(`name-${color}-${i}`).value = data.name || '';
                document.getElementById(`link-${color}-${i}`).value = data.link || '';
                if(data.image) document.getElementById(`preview-${color}-${i}`).src = data.image;
            }
        }
        const savedMembers = JSON.parse(localStorage.getItem('team_' + color + '_members'));
        if (savedMembers && Array.isArray(savedMembers)) {
            dataStore[color].members = savedMembers;
        }
        renderMembers(color);
    }

    function previewLeader(input, color, num) {
        if (input.files && input.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                document.getElementById(`preview-${color}-${num}`).src = e.target.result;
            };
            reader.readAsDataURL(input.files[0]);
        }
    }

    function addMember(color) {
        const nameInput = document.getElementById(`new-name-${color}`);
        const linkInput = document.getElementById(`new-link-${color}`);
        const fileInput = document.getElementById(`new-file-${color}`);

        if(!nameInput.value) { alert("åå‰ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„"); return; }

        const newMember = { name: nameInput.value, link: linkInput.value, image: '' };

        if (fileInput.files && fileInput.files[0]) {
            const reader = new FileReader();
            reader.onload = function(e) {
                newMember.image = e.target.result;
                finalizeAddMember(color, newMember);
            };
            reader.readAsDataURL(fileInput.files[0]);
        } else {
            newMember.image = 'https://placehold.jp/150x150.png?text=NoImg';
            finalizeAddMember(color, newMember);
        }
    }

    function finalizeAddMember(color, member) {
        dataStore[color].members.push(member);
        document.getElementById(`new-name-${color}`).value = '';
        document.getElementById(`new-link-${color}`).value = '';
        document.getElementById(`new-file-${color}`).value = '';
        renderMembers(color);
        checkStorageUsage(); // è¿½åŠ ã—ãŸæ™‚ç‚¹ã§å®¹é‡ç¢ºèª
    }

    function renderMembers(color) {
        const listDiv = document.getElementById(`list-${color}`);
        listDiv.innerHTML = '';
        dataStore[color].members.forEach((member, index) => {
            const div = document.createElement('div');
            div.className = 'member-item';
            div.innerHTML = `
                <img src="${member.image}" class="member-thumb">
                <div class="member-info"><div class="member-name">${member.name}</div></div>
                <button class="del-btn" onclick="deleteMember('${color}', ${index})">å‰Šé™¤</button>
            `;
            listDiv.appendChild(div);
        });
    }

    function deleteMember(color, index) {
        if(confirm('å‰Šé™¤ã—ã¾ã™ã‹ï¼Ÿ')) {
            dataStore[color].members.splice(index, 1);
            renderMembers(color);
            checkStorageUsage();
        }
    }

    // --- å®¹é‡ãƒã‚§ãƒƒã‚¯æ©Ÿèƒ½ ---
    function checkStorageUsage() {
        let total = 0;
        for (let key in localStorage) {
            if (localStorage.hasOwnProperty(key)) {
                total += localStorage[key].length * 2; // æ–‡å­—æ•°*2ãƒã‚¤ãƒˆ(æ¦‚ç®—)
            }
        }
        // 5MBã‚’ä¸Šé™ã¨ã™ã‚‹ (ç´„5,242,880ãƒã‚¤ãƒˆ)
        const limit = 5242880;
        const percentage = Math.min((total / limit) * 100, 100).toFixed(1);
        
        const fill = document.getElementById('storageFill');
        const text = document.getElementById('storageText');
        
        fill.style.width = percentage + '%';
        text.textContent = `ç¾åœ¨ã®ä½¿ç”¨é‡: ç´„ ${percentage}% (ç”»åƒãŒå¤§ãã™ãã‚‹ã¨100%ã‚’è¶…ãˆã¦ä¿å­˜ã§ãã¾ã›ã‚“)`;

        if(percentage > 90) {
            fill.style.background = 'red';
            text.style.color = 'red';
            text.style.fontWeight = 'bold';
        } else {
            fill.style.background = '#4caf50';
            text.style.color = '#666';
        }
    }

    // --- å…¨ä¿å­˜ (ã‚¨ãƒ©ãƒ¼ãƒãƒ³ãƒ‰ãƒªãƒ³ã‚°ä»˜ã) ---
    function saveAllData() {
        const msg = document.getElementById('msg');
        msg.textContent = "ä¿å­˜ä¸­...";
        msg.className = "";

        try {
            TEAMS.forEach(team => {
                const color = team.id;
                const leadersToSave = [];
                for(let i = 1; i <= 2; i++) {
                    const name = document.getElementById(`name-${color}-${i}`).value;
                    const link = document.getElementById(`link-${color}-${i}`).value;
                    const img = document.getElementById(`preview-${color}-${i}`).src;
                    
                    // Base64ãƒ‡ãƒ¼ã‚¿ã‹ã©ã†ã‹ã®ç°¡æ˜“ãƒã‚§ãƒƒã‚¯
                    const validImg = (img && img.startsWith('data:image')) ? img : ''; 
                    leadersToSave.push({ name, link, image: validImg });
                }
                
                localStorage.setItem('team_' + color + '_leaders', JSON.stringify(leadersToSave));
                localStorage.setItem('team_' + color + '_members', JSON.stringify(dataStore[color].members));
            });

            msg.textContent = "âœ… å…¨ãƒ‡ãƒ¼ã‚¿ã‚’ä¿å­˜ã—ã¾ã—ãŸï¼";
            msg.style.color = "green";
            checkStorageUsage(); // ãƒ¡ãƒ¼ã‚¿ãƒ¼æ›´æ–°

        } catch (e) {
            console.error(e);
            // å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã‚¨ãƒ©ãƒ¼(QuotaExceededError)ã®æ¤œå‡º
            if (e.name === 'QuotaExceededError' || e.code === 22) {
                alert("âŒ ä¿å­˜å¤±æ•—ï¼\n\nç”»åƒã®å®¹é‡ãŒå¤§ãã™ãã¦ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸã€‚\nç”»åƒã‚’ã€Œãƒªã‚µã‚¤ã‚ºï¼ˆç¸®å°ï¼‰ã€ã—ã¦ã‹ã‚‰ç™»éŒ²ã—ç›´ã—ã¦ãã ã•ã„ã€‚\n\nç›®å®‰ï¼šç”»åƒ1æšã‚ãŸã‚Š500KBä»¥ä¸‹æ¨å¥¨");
                msg.textContent = "âŒ å®¹é‡ã‚ªãƒ¼ãƒãƒ¼ã§ä¿å­˜ã§ãã¾ã›ã‚“ã§ã—ãŸ";
                msg.className = "alert";
            } else {
                alert("ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ: " + e.message);
                msg.textContent = "âŒ ã‚¨ãƒ©ãƒ¼ç™ºç”Ÿ";
                msg.className = "alert";
            }
        }
    }
</script>

</body>
</html>